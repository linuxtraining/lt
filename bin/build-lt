#!/bin/sh

# Nightly build script.
# This script generates all the books for the download page on the website.
# (c) 2010 Serge van Ginderachter

( echo "$1" | grep  "\-v" >/dev/null )  && V="-v"

# environment
wwwbooksdir=~/www/default/wp-content/blogs.dir/linux-training/files/books/
cd ~/src/lt
outputdir=./output
www=~/proj/wwwfiles
MAKEOPTS=""
rm $V -rf $www
mkdir $V -p $www

# pull in latest buildfiles
CURRENT_REV=$(git show  | grep "^commit")
git pull $V | grep -v "Already up-to-date"
NEW_REV=$(git show  | grep "^commit")

# check if the version changed, if not just exit unless the force switch is on.
if [ "$CURRENT_REV" = "$NEW_REV" ]
then    [ -z "$V" ] || echo "No updates."
        ( echo "$1" | grep "\-f" >/dev/null ) || exit 0
else    echo "Revision bumped from $CURRENT_REV to $NEW_REV."
fi

# fresh start
clean () {
        ./make.sh $MAKEOPTS clean
        rm -rf $outputdir
}
clean

# LinuxFun
./make.sh $MAKEOPTS html fundamentals
mkdir $V -p $www/html/
mv $V -T $outputdir/html $www/html/fun
./make.sh $MAKEOPTS build fundamentals
./make.sh $MAKEOPTS clean
mv $V $outputdir/*.pdf $www/LinuxFun.pdf
                  
# LinuxAdm
./make.sh $MAKEOPTS build sysadmin
./make.sh $MAKEOPTS clean
mv $V $outputdir/*.pdf $www/LinuxAdm.pdf

# LinuxSrv
./make.sh $MAKEOPTS build advanced
./make.sh $MAKEOPTS clean
mv $V $outputdir/*.pdf $www/LinuxSrv.pdf

# LinuxTraining
./make.sh $MAKEOPTS build complete
./make.sh $MAKEOPTS clean
mv $V $outputdir/*.pdf $www/LinuxTraining.pdf

# DataNet
cp lib/20101106-DataNet.pdf $www/DataNet.pdf

# cleanup
clean

rsync $V -a $www/ $wwwbooksdir/ --delete || exit 1

exit 0
}
